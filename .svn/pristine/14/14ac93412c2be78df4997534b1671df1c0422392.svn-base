'use strict';
const express = require("express");

const cookieParser = require('cookie-parser');
const morgan = require('morgan');
const path = require('path');
//const session = require('express-session');
const flash = require('connect-flash');
const passport = require('passport');
const LocalStrategy = require('passport-local').Strategy;
//const auth = require('basic-auth');
require('dotenv').config();
const cookieSession = require('cookie-session');

const pageRouter = require('./routes/page');
const authRouter = require('./routes/auth');

// const { sequelize } = require('./models');
const passportConfig = require('./passport');
const bodyParser = require("body-parser");
const dao = require('./database/');

const apiService = require('./apiService/openApi');
const uniPassApiService = require('./apiService/uniPassOpenApi');
const downloadExcel = require('./downLoadFile/downloadService');
// const bcrypt = require('bcrypt');
const { isLoggedIn, isNotLoggedIn, isVerifyToken } = require('./routes/middlewares');

const app = express();
// sequelize.sync();
passportConfig(passport);
const swaggerRouter = require('./swagger/swaggerDoc'); //swagger 설정 정의
const sUser = require('./models/sessionUser');
//console.log("sUser:",sUser);

app.set('views', path.join(__dirname, 'views')); //템플리트 엔진을 사용 1
app.set('view engine', 'pug'); //템플리트 엔진을 사용 2
app.use(swaggerRouter);//swagger API
app.use(morgan('dev')); //morgan: 요청에 대한 정보를 콘솔에 기록
app.use(express.static(path.join(__dirname, 'public'))); //static: 정적인 파일을 제공, public 폴더에 정적 폴더를 넣는다.
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(cookieParser('nodebirdsecret')); //cookie-parser: 요청에 동봉된 쿠키를 해석
app.use(cookieSession({   //express-session: 세션 관리용 미들웨어, 로그인 드의 이유로 세션을 구현할 때 유용하다.
    resave: false,
    saveUninitialized: false,
    secret: 'nodebirdsecret',
    cookie: {
        httpOnly: true,
        secure: false,
        rolling:true,
        //store:sessionStore,
        //saveUninitialized:true,
        maxAge: 1000 * 60 * 60, // 유효기간 1시간
    },
}));

	 
// app.use(cookieSession({
//     keys: ['node_yun'],
//     cookie: {
//       maxAge: 1000 * 60 * 60 // 유효기간 1시간
//     }
// }));
app.use(flash()); //connect-flash: 일회성 메시지들을 웹 브라우저에 나타낼 때 사용한다. cookie-parser와 express-session 뒤에 위치해야한다.
app.use(passport.initialize());
app.use(passport.session());

/*
2020.01.21 pdk ship 개발 혹은 테스트 기간중 아래 세션 체크 로직 편의상 막아도 됨

app.route(/^((?!\/auth\/|\/login).)*$/s).all(function(req, res, next) {    
	var path = req.params[0];
	console.log("(server.js) path:",path);
    // if (req.isAuthenticated !== undefined && req.isAuthenticated()){
    if (req.isAuthenticated()){
      console.log('로그인 정보 남아 있음.', req.session.sUser);
      next();
    } else {
      var fullUrl = req.protocol + '://' + req.headers.host + req.originalUrl;
      console.log( fullUrl );
      console.log('로그인 정보 없음 예외 처리');
      // console.log(req.headers.host);
      // return res.redirect('http://' + req.headers.host + '/login/?redirect=' + fullUrl);
      //return res.redirect('http://' + req.headers.host + '/login');

      // return;
      // const err = new Error('Not Found');
      // err.status = 404;
      // next(err);

      // req.logout();
      // req.session.destroy();
      // res.redirect('/');   
      // return res.redirect('http://' + req.headers.host + '/auth/');
      // return res.redirect('/auth/logout');
      // next('/auth/logout');
      next('not login');
    }

	// if ( req.session.user ) { 
	// 	console.dir( req.session.user );
	// 	console.log('로그인 정보 남아 있음.');
	// 	next();
	// } else {
	// 	var fullUrl = req.protocol + '://' + req.headers.host + req.originalUrl;
	// 	console.log( fullUrl );
  //       console.log('로그인 정보 없음 예외 처리');
  //       console.log(req.headers.host);
  //       // return res.redirect('http://' + req.headers.host + '/login/?redirect=' + fullUrl);
  //       //return res.redirect('http://' + req.headers.host + '/login');

  //       return;
  // }
})
*/

app.use('/', pageRouter); // 2020.04.17 pdk ship Login 필요 없는 페이지 정의 혹은 Login 전 접근해야 하는 페이지 정의

app.route(/^((?!\/auth\/|\/api\/).)*$/s).all(isVerifyToken,function(req, res, next) {    
	var path = req.params[0];
  console.log("(server.js) path:",path);

  if ( req.session.sUser.userno ) { 
//     console.dir( req.session.sUser );
//     console.log('로그인 정보 남아 있음.');
//     console.log(req.originalUrl);
     next();
  } else {
    
//     var fullUrl = req.protocol + '://' + req.headers.host + req.originalUrl;
//    // console.log( fullUrl );
//     console.log('로그인 정보 없음 예외 처리');
//     //console.log(req.headers.host);
//     req.logout();
//     //res.clearCookie('connect.sid');
     return res.status(401).json({ errorcode: 401, error: 'unauthorized' });
  }
});

app.use('/auth', authRouter);


app.use(bodyParser.json()); //요청의 본문을 해석해주는 미들웨어 1
app.use(bodyParser.urlencoded({ extended: true })); //요청의 본문을 해석해주는 미들웨어 2


// const oracleConfig = require('./config_oracle.js');
// const pgsqlConfig = require('./config_postgresql.js');



//데이터베이스 사용 방법 아래 API 참조
//ORACLE API https://oracle.github.io/node-oracledb/doc/api.html
//POSTGRES API https://node-postgres.com/api
//DB별 서비스별 klnet.owner.web\database\oracle\, klnet.owner.web\database\postgresql\ 위치에 파일 만들고 쿼리별 함수 선언
//위 함수를 해당 파일의 module에 module.exports 를 등록하여 사용
//get, post, put, delete 등 method 별로 exports한 함수를 맵핑하여 사용
//하위 예시 참조
//klnet.owner.web\database\oracle\template.js
//klnet.owner.web\database\postgresql\template.js 

//ORACLE API https://oracle.github.io/node-oracledb/doc/api.html
//POSTGRES API https://node-postgres.com/api

app.get("/auth/getTestQuerySample", dao.postgresql.getTestQuerySample);
//위치
app.get("/loc/downloadExcel",downloadExcel.blExcelDownload);
app.get("/loc/getTestSimple", dao.postgresql.getTestSimple);
app.post("/loc/getPortLocation",dao.postgresql.getPortLocation);
app.post("/loc/getPort",dao.postgresql.getPort);
app.post("/loc/getCustomLineCode", dao.pgcodes.getCustomLineCode);
app.get("/loc/getTestQuerySample", dao.postgresql.getTestQuerySample);
app.get("/loc/getTestQueryParamSample", dao.postgresql.getTestQueryParamSample);
app.post("/loc/getTestQueryAttibuteSample", dao.postgresql.getTestQueryAttibuteSample);

//app.post("/loc/getCustomLineCode", dao.tracking.getCustomLineCode);
app.post("/loc/getTrackingList", dao.pgtracking.getTrackingList);
app.post("/loc/getMyBlList", dao.pgtracking.getMyBlList);
app.post("/loc/setUserBLUpdate", dao.pgtracking.setUserBLUpdate);
app.post("/loc/updateMyBlNo", dao.pgtracking.updateMyBlNo);
app.post("/loc/getPkMyBlList", dao.pgtracking.getPkMyBlList);
app.post("/loc/deleteMyBlNo", dao.pgtracking.deleteMyBlNo);
app.post("/loc/getBookMark", dao.pgtracking.getBookMark);
app.post("/loc/getCntrList", dao.pgtracking.getCntrList);
app.post("/loc/getCntrDetailList", dao.pgtracking.getCntrDetailList);
app.post("/loc/saveBlList", dao.pgtracking.saveBlList);
app.post("/loc/insertBlRequest",dao.pgtracking.insertBlRequest);
app.post("/loc/getDemdetDtlCurrent",dao.pgtracking.getDemdetDtlCurrent);
app.post("/loc/getdemdetCurrent", dao.pgtracking.getdemdetCurrent);
app.post("/loc/getDemdetCntrList", dao.pgtracking.getDemdetCntrList);
app.post("/loc/getHotInfo", dao.tracking.getHotInfo);
app.post("/loc/getDemDetList", dao.pgdemdet.getDemDetList);
app.post("/loc/getTarrifList", dao.pgdemdet.getTarrifList);
app.post("/loc/getScrapManageList", dao.pgtracking.getScrapManageList);

//공통
app.post("/com/getUserSetting", dao.pgtracking.getUserSetting);
app.post("/com/getCarrierInfo", dao.pgtracking.getCarrierInfo);
app.post("/com/setUserSetting", dao.pgtracking.setUserSetting);
app.post("/com/getUserInfo", dao.pgusers.getUserInfo);
app.get("/com/getPortCodeInfo", dao.pgcodes.getPortCodeInfo);
app.post("/com/getPortCode", dao.pgcodes.getPortCode);
app.post("/com/getUserInfoSample", dao.postgresql.getUserInfoSample);
app.post("/com/getImpFlowSample", dao.oracle.getImpFlowSample);
app.post("/com/getExpFlowSample", dao.oracle.getExpFlowSample);
app.post("/com/getBoardList", dao.pgboard.getBoardList);
app.post("/com/getBoardDetail", dao.pgboard.getBoardDetail);
app.post("/com/saveBoard", dao.pgboard.saveBoard);
app.post("/com/deleteBoard", dao.pgboard.deleteBoard);

//스케줄
app.post("/sch/getScheduleSample", dao.schedule.getScheduleSample);
app.post("/sch/getTestQueryAttibuteSample", dao.oracle.getTestQueryAttibuteSample);
app.post("/sch/snkMasterList", dao.postgresql.getSnkMasterList );
app.post("/sch/kmdMasterList", dao.postgresql.getKmdMasterList );
app.post("/sch/ymlMasterList", dao.postgresql.getYmlMasterList );
app.post("/sch/getCarrierInfo", dao.schedule.getCarrierInfo);
app.post("/sch/getScheduleList", dao.schedule.getScheduleList);
app.post("/sch/getPortCodeInfo", dao.schedule.getPortCodeInfo);
app.post("/sch/getScheduleDetailList", dao.schedule.getScheduleDetailList);

app.post("/sch/getSchedulePortCodeList", dao.schedule.getSchedulePortCodeList);
app.post("/sch/insertSchPortCode", dao.schedule.insertSchPortCode);
app.post("/sch/updateSchPortCode", dao.schedule.updateSchPortCode);
app.post("/sch/deleteSchPortCode", dao.schedule.deleteSchPortCode);


//외부 api
app.get("/api/apiSchedule", apiService.apiScheduleInfo);

// UNI PASS API 호출용 
app.post("/com/uniPassApiExportAPI001", uniPassApiService.API001);
app.post("/com/uniPassApiExportAPI002", uniPassApiService.API002);
// 공지 게시판
app.post("/api/getBoardList", dao.pgboard.getBoardList);
app.post("/api/getBoardDetail", dao.pgboard.getBoardDetail);

//에러 처리 미들웨어: error라는 템플릿 파일을 렌더링한다. 404에러가 발생하면 404처리 미들웨어에서 넣어준 값을 사용한다.
app.use((req, res, next) => {
    const err = new Error('Not Found');
    err.status = 404;
    next(err);
});

app.use((err, req, res) => {
    res.locals.message = err.message;
    res.locals.error = req.app.get('env') === 'development' ? err : {};
    res.status(err.status || 500);
    res.render('error');
});




const port = process.env.PORT || 5000;
app.listen(port, () => console.log(`Listening on port ${port}`));
